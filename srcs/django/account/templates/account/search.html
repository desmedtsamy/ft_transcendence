{% extends 'base.html' %}

{% load static %}
{% block head %}
<link rel="stylesheet" href="{% static 'css/account/search.css' %}">
{% endblock %}

{% block content %}
<meta name="csrf-token" content="{{ csrf_token }}">
<div class="container mt-5">
    <h2>Rechercher des utilisateurs</h2>

    <form method="get" action="{% url 'account:search_users' %}">
        <div class="fields">
            <label for="query">Recherche :</label>
            <input type="text" name="query" id="query" value="{{ query }}" onkeyup="searchUsers()">
        </div>
    </form>

    <ul id="search-results" class="user_list">
        {% if users %}
            {% for user in users %}
                <li class= "user_element">
                    <a href="{% url 'account:profile' user.username %}">
                        <div class="avatar-container">
                            <img class="avatar" src="{{ user.avatar.url }}" alt="Avatar de {{ user.username }}">

                            {% if user.is_online %}
                                <span class="online-status"><i class="fas fa-circle"></i></span>
                            {% else %}
                                <span class="offline-status"><i class="fas fa-circle"></i></span>
                            {% endif %}
                        </div>
                        {{ user.username }}
                    </a>

                    {% if user in friends %}
                        <form method="post" action="{% url 'account:remove_friend' user.id %}">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-danger"><i class="fas fa-user-times"></i></button>
                        </form>
                    {% elif user.pk in friend_requests_sent %}
                        Demande envoyée
                        <form method="post" action="{% url 'account:remove_friend_request' user.id %}">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-danger">annuler</button>
                        </form>
                    {% elif user.pk in friend_requests_received %}
                        Demande en attente
                        <form method="post" action="{% url 'account:accept_friend_request' user.id %}">
                            {% csrf_token %}
                            <button type="submit" class="btn">Accepter</button>
                        </form>
                        <form method="post" action="{% url 'account:reject_friend_request' user.id %}">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-danger">Refuser</button>
                        </form>
                    {% else %}
                        <form method="post" action="{% url 'account:send_friend_request' user.id %}">
                            {% csrf_token %}
                            <button type="submit" class="btn"><i class="fas fa-user-plus"></i></button>
                        </form>
                    {% endif %}
                </li>
            {% endfor %}
        {% else %}
            {% if query %}
                <p>Aucun utilisateur trouvé pour la recherche "{{ query }}".</p>
            {% endif %}
        {% endif %}
    </ul>
</div>

<script>
function searchUsers() {
    const query = document.getElementById('query').value;
    fetch('{% url 'account:search_users' %}?query=' + query, {
        method: 'GET',
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Erreur lors de la requête : ' + response.status);
        }
        return response.text();
    })
    .then(data => {
        document.getElementById('search-results').innerHTML = data;
    })
    .catch(error => {
        console.error('Erreur AJAX :', error);
    });
}
</script>
{% endblock content %}
